<!-- index.html -->
<html>
  <head>
    <title>Game Value Mangement Tools </title>
    <script src="./library/traceur-runtime@0.0.87.js"></script>
    <script src="./library/system@0.16.11.js"></script>
    <script src="./config.js"></script>

    <script src="./library/jquery-1.11.3.js"></script>
    <script src="./library/socket.io-1.3.5.js"></script>
    <script src="./library/xlsx/xlsx.full.min.js"></script>
    <script src="./library/FileSaver.js"></script>
  </head>
  <body>

  <input type="file" id="theFile" style="display:none;"/>
    <button id='upfile'>上传</button>
    <button id="savefile">下载</button>
    <!-- The app component created in app.ts -->
  <!--   <application>
    Loading
  </application> -->

    <script>
    //System.import('dist/src/index');


    function ToNumberSystem26(n){
        var s = '';
        while (n > 0){
            var m = n % 26;
            if (m == 0) m = 26;
            s = String.fromCharCode(m + 64) + s;
            n = (n - m) / 26;
        }
        return s;
    }
    function FromNumberSystem26(s){
        if (!s) return 0;
        var n = 0;
        for (var i = s.length - 1, j = 1; i >= 0; i--, j *= 26){
            var c = s[i].toUpperCase();
            if (c < 'A' || c > 'Z') return 0;
            n += (c.charCodeAt() - 64) * j;
        }
        return n;
    }

    var data = [];
    function handleFile(e) {
      var files = e.target.files;
      var i,f;
      for (i = 0, f = files[i]; i != files.length; ++i) {
        var reader = new FileReader();
        var name = f.name;
        reader.onload = function(e) {
          var _data = e.target.result;
          var workbook = XLSX.read(_data, {type: 'binary'});
          var first_sheet_name = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[first_sheet_name];
          data = array_of_arrays_from_sheet(worksheet);
          /* DO SOMETHING WITH workbook HERE */
        };
        reader.readAsBinaryString(f);
      }
    }
    var input_dom_element = document.querySelector('#theFile');
    input_dom_element.addEventListener('change', handleFile, false);

    document.querySelector('#upfile').addEventListener('click',function(){
      var elem = document.querySelector('#theFile');
      if(elem && document.createEvent) {
        var evt = document.createEvent("MouseEvents");
        evt.initEvent("click", true, false);
        elem.dispatchEvent(evt);
      }
    });

    function s2ab(s) {
      var buf = new ArrayBuffer(s.length);
      var view = new Uint8Array(buf);
      for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
      return buf;
    }

    function array_of_arrays_from_sheet(sheet,opts){


      var data = [];
      var buf_array = [];
      var buf_count = 0;
      for (z in sheet) {
          /* all keys that do not begin with "!" correspond to cell addresses */
          if(z[0] === '!') continue;
          var value = JSON.stringify(sheet[z].v);
          var regList = z.match(/([A-Z]*)(\d*)/);
          var x = FromNumberSystem26(regList[1]) - 1;
          var y = regList[2]*1 - 1;
          if(data[y]){
            data[y][x] = value;
          }else{
            data[y] = [];
            data[y][x] = value;
          }
      }
      console.log(data);
      return data;
    }

    function arrayLength(array){
      if(array){
        return array.length;
      }else{
        return 0;
      }
    }



    function sheet_from_array_of_arrays(data, opts) {

    	var ws = {};
    	var range = {s: {c:10000000, r:10000000}, e: {c:0, r:0 }};
    	for(var R = 0; R != arrayLength(data); ++R) {
    		for(var C = 0; C != arrayLength(data[R]); ++C) {
    			if(range.s.r > R) range.s.r = R;
    			if(range.s.c > C) range.s.c = C;
    			if(range.e.r < R) range.e.r = R;
    			if(range.e.c < C) range.e.c = C;
    			var cell = {v: data[R][C] };
    			if(cell.v == null) continue;
    			var cell_ref = XLSX.utils.encode_cell({c:C,r:R});

    			if(typeof cell.v === 'number') cell.t = 'n';
    			else if(typeof cell.v === 'boolean') cell.t = 'b';
    			else if(cell.v instanceof Date) {
    				cell.t = 'n'; cell.z = XLSX.SSF._table[14];
    				cell.v = datenum(cell.v);
    			}
    			else cell.t = 's';

    			ws[cell_ref] = cell;
    		}
    	}
    	if(range.s.c < 10000000) ws['!ref'] = XLSX.utils.encode_range(range);
    	return ws;
    }

    function Workbook() {
    	if(!(this instanceof Workbook)) return new Workbook();
    	this.SheetNames = [];
    	this.Sheets = {};
    }

    function handleSave(e){
            var ws_name = "SheetJS";
      var wb = new Workbook(), ws = sheet_from_array_of_arrays(data);
      wb.SheetNames.push(ws_name);
      wb.Sheets[ws_name] = ws;
      var wbout = XLSX.write(wb, {bookType:'xlsx', bookSST:true, type: 'binary'});
      /* the saveAs call downloads a file on the local machine */
      saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}), "test.xlsx")

    }

    var save_file_btn = document.querySelector("#savefile");
    save_file_btn.addEventListener('click',handleSave,false);
    </script>
  </body>
</html>
